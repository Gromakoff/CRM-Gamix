# Cloudflare D1: схема, миграции и тестовый сид

Этот каталог содержит готовую схему D1 для всех разделов панели:

- **Витрина (showcase)**: товары со статусом `showcase`, цена продажи `listing_price_usd`, публикации на площадках.
- **Склад (warehouse)**: товары со статусом `warehouse`, история закупок и движения по статусам.
- **Hand-Trade**: записи с `entry_type = 'hand'` и владельцем `owner_id` (роль Trader). Для них отдельные индексы по владельцу.
- **Пользователи/роли**: таблицы `roles`, `users` с ролями Admin/Trader и индексом по активным пользователям.

## Состав

- `schema.sql` — единый файл схемы для локальной разработки.
- `migrations/001_initial.sql` — миграция для развёртывания на D1 через `wrangler`.
- `seed.sql` — примерное наполнение для тестирования витрины, склада, Hand-Trade и проданных лотов.

## Применение миграций

1. Создать привязку D1 в `wrangler.toml`, например: `[[d1_databases]] binding = "DB" database_name = "gmhub"`.
2. Выполнить миграцию: `wrangler d1 migrations apply gmhub` (прочитает `migrations/001_initial.sql`).
3. При необходимости миграцию можно выполнить вручную: `wrangler d1 execute gmhub --file=worker/db/migrations/001_initial.sql`.

## Сценарий сида

Выполнить: `wrangler d1 execute gmhub --file=worker/db/seed.sql`.

Сид создаёт:

- Роли **Admin** и **Trader**, пользователей `admin` и `trader01`.
- Две игры и по одному набору фильтров для них (для связи с поиском/витриной).
- Четыре товара: в корзине (Taobao), на складе, в Hand-Trade (трейдер-владелец) и проданный лот.
- Историю цен и статусов по каждому из этих лотов.
- Настройки с ключом RapidAPI и курсом CNY, а также примерные уведомления.

Такое наполнение позволяет проверить: смену статусов (корзина → склад → витрина → продано), связку Hand-Trade с пользователем роли Trader, расчёт маржи по продажам и отображение готовых лотов на витрине.
