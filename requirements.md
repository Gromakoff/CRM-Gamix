# Game Trade Hub — Требования

## 1. Описание проекта

Game Trade Hub — это внутренняя CRM/панель для арбитража цифровых игровых ценностей. Система агрегирует данные о товарах с китайских площадок (главным образом Taobao/Tmall через открытые API), даёт возможность настраивать фильтры под разные игры и типы ресурсов, автоматизирует создание внутренней «корзины» и «склада», а также предоставляет инструменты для анализа трендов и публикации на биржах продаж (например, FunPay). Система разрабатывается на бесплатных возможностях Cloudflare, а данные о товарах берутся с помощью API сервиса Just One API (таобао/тамалл через RapidAPI). 

### 1.1 Источники данных

* **Taobao/Tmall через RapidAPI** – сервис `taobao-tmall-all-api1.p.rapidapi.com` (Just One API) предоставляет методы для поиска товаров, получения деталей (название, изображения, цена, продавец, доставки), описаний, отзывов и статистики продаж. Он не содержит функций для управления корзиной и заказами Taobao, поэтому корзина и склад реализуются в нашей CRM, а покупки осуществляются вручную или через агентскую систему. 
* В перспективе могут подключаться другие агрегаторы (OneBound, PandaPon, OTAPI), если они отвечают бюджетным требованиям и закрывают дополнительные потребности.

### 1.2 Цель и основные возможности

1. Автоматический поиск товаров по заданным фильтрам (игра, тип ресурса, диапазон цен, параметры).  
2. Создание списка найденных товаров с возможностью массового выбора (до 50 позиций на страницу) и добавления в «корзину».  
3. Ведение внутренней корзины и склада: корзина для планируемых покупок; склад для товаров, уже выкупленных вручную; витрина для опубликованных и готовых к продаже товаров.  
4. Возможность редактирования карточек товаров, генерация описаний на русском и английском языках (с использованием бесплатных сервисов перевода и AI‑моделей).  
5. Публикация товаров на биржах (на первом этапе — FunPay) и отслеживание статуса продаж.  
6. Аналитика продаж: расчёт расхода, дохода и чистой прибыли по каждой игре; прогнозируемый доход по товарам в продаже; динамика по периодам и разрез по площадкам.  
7. Раздел «Тренды», где отображаются изменения спроса на игровые аккаунты и ресурсы (на основе статистики продаж, отзывов, поискового интереса).  
8. Система ролей: **Admin** (полный доступ) и **Trader** (работа только в разделе Hand‑Trade).  
9. Раздел «Настройки» для подключения к источникам данных (RapidAPI token), настройки интеграций с биржами, управления курсами валют и наценками, а также раздел «Пользователи» для управления логинами и паролями. 

## 2. Ограничения и предположения

* **Корзина и заказы в Taobao**: API Just One API не предоставляет возможности добавления товаров в корзину и совершения заказов. Поэтому корзина реализуется в нашей базе (Cloudflare D1) как список товаров, которые мы собираемся покупать, а сама покупка выполняется вручную либо через партнёрский сервис/агента.  
* **Покупка**: на первом этапе выкуп товаров происходит вне системы: оператор переходит по ссылке на товар и оформляет заказ в Taobao вручную. После покупки информация заносится в раздел «Склад».  
* **Бюджет**: система разворачивается на бесплатных тарифах Cloudflare. Наиболее затратная часть – интеграция с платными API (если возникнет потребность), например OneBound (~¥5 000/год). За пределами этого бюджеты ограничены ≈50 $ в месяц.  
* **Перевод текста**: переводы делаются бесплатно посредством публичных API (Yandex.Translate, Microsoft Translator) с распределением нагрузки между ними. В перспективе можно использовать бесплатные AI‑модели (DeepSeek) для перевода или генерации описаний.  
* **Изображения**: чтобы не тратить ресурсы на скачивание и OCR, система использует миниатюры изображений и ссылки на оригинал с Taobao. Удаление китайских иероглифов с изображений и инпейнтинг откладываются на будущее.  
* **Безопасность**: ключи API хранятся в переменных окружения Cloudflare Workers. Пароли пользователей хэшируются и не хранятся в открытом виде.  

## 3. Роли пользователей

### 3.1 Admin

* полный доступ ко всем разделам CRM;
* управление пользователями и их ролями (создание, удаление);  
* управление подключениями к источникам данных и площадкам (RapidAPI, FunPay и др.);  
* настройка системных параметров: курс валюты, коэффициенты наценки, лимиты парсинга;  
* просмотр и анализ статистики и трендов.  

### 3.2 Trader

* доступ только к разделу **Hand‑Trade**, где можно добавлять свои товары вручную и отслеживать их продажи;  
* просмотр списка собственных товаров на складе/витрине/продано;  
* нет доступа к глобальным настройкам, чужим товарам и статистике.  

## 4. Разделы интерфейса

### 4.1 Обзор (Dashboard)

Отображает общую информацию за день/неделю:  
* общая сумма закупки на Taobao;  
* общая сумма продаж на биржах;  
* ожидаемый доход по текущим лотам;  
* индикатор состояния лимитов Cloudflare (Workers, D1, R2, AI).  

### 4.2 Витрина (Showcase)

Список активных товаров, которые готовы к продаже или уже размещены на биржах. В таблице: игра, тип ресурса, закупочная цена, цена продажи, маржа, статус (новый, опубликован, продан). По каждому товару доступна карточка с полным описанием, параметрами, ссылкой на товар на Taobao, ссылкой на биржу.  

### 4.3 Продано (Sold)

Раздел отражает завершённые сделки. Для каждой записи: дата, игра, цена закупки, цена продажи, комиссия, маржа, чистая прибыль, площадка продажи. Возможна фильтрация по игре, периоду, площадке.  

### 4.4 Hand‑Trade

Раздел для ручного ввода товаров от трейдеров. Трейдер указывает название, игру, тип ресурса, цену, описание, выбирает площадку для публикации. Товары в этом разделе отслеживаются отдельно от автоматизированных.  

### 4.5 Склад (Warehouse)

Список выкупленных товаров, ожидающих проверки и публикации. Здесь можно редактировать описание, задавать цены, выбирать площадки для публикации. После публикации товар перемещается в Витрину.  

### 4.6 Статистика

Раздел, где рассчитываются и отображаются метрики:

* расход, доход и чистая прибыль по каждой игре и по всем играм;  
* ожидаемый доход по товарам в продаже;  
* разрез по площадкам (FunPay, другие биржи);  
* динамика показателей за выбранный период (день, неделя, месяц).  

### 4.7 Тренды

Раздел анализа спроса на игровые товары. Источники: данные Taobao (API Sales, Comments), сторонние форумы, выдачи поисковых систем, биржи. В трендах отображаются:

* рост или спад интереса к конкретным играм/ресурсам (по числу заказов, продаж, отзывов);  
* горячие категории и типы товаров;  
* топ‑10 игр/ресурсов по спросу;  
* графики изменения цен и продаж.  

### 4.8 Настройки

Раздел для конфигурации:

* токены RapidAPI (Just One API) и других источников данных;  
* параметры обмена (валюты, коэффициенты наценки);  
* управление интеграциями с биржами (логин/пароль, доступ по API, комиссия);  
* параметры фильтров по каждой игре (диапазоны цен, уровней, статусов, процент наценки).  

### 4.9 Пользователи

Управление логинами и ролями. Админ может добавлять пользователей с ролями Admin или Trader. Хранение паролей — в виде хэшей.  

### 4.10 Уведомления

Раздел показывает системные уведомления: ошибки интеграций, новые сделки, превышения лимитов, оповещения о событиях (например, товар продан). В будущем уведомления могут дублироваться в Telegram.  

## 5. Интеграции и зависимости

* **Just One API / RapidAPI** – основной источник данных по Taobao/Tmall. Используется для поиска товаров, получения описаний, отзывов и статистики продаж.  
* **Cloudflare D1** – SQL‑база для хранения информации о товарах, корзине, складе, пользователях, заказах и статистике.  
* **Cloudflare Workers** – backend‑слой (API) для обработки запросов от фронта, интеграции с внешними сервисами, хранения и обработки данных.  
* **Cloudflare Pages** – фронт‑end (административная панель на Tailwind CSS).  
* **Cloudflare R2/Images** – хранилище для изображений товаров; на первом этапе используются только внешние ссылки, но в будущем можно загружать изображения в R2 или пользоваться Cloudflare Images.  
* **Cloudflare Workers AI** – сервис для запуска нейросетевых моделей (перевод, генерация описаний). Бесплатная квота 10 000 нейронов в день позволяет обрабатывать до 1000 небольших текстов в сутки практически без затрат.  
* **FanPay** (и другие биржи) – площадка для публикации товаров. Интеграция реализуется через HTTP‑запросы или полуручно (нет открытого API); публикация и отслеживание продаж требует авторизации под аккаунтом продавца.  

## 6. План дальнейших шагов

1. Создать структуру репозитория: разделить фронт‑end (Cloudflare Pages + Tailwind) и backend (Cloudflare Worker).  
2. Реализовать базовую админку (Dashboard, Витрина, Продано, Hand‑Trade, Склад, Статистика, Тренды, Настройки, Пользователи, Уведомления).  
3. Настроить Cloudflare D1: создать таблицы для игр, фильтров, товаров, корзины, склада, заказов, пользователей.  
4. Реализовать API‑клиент к Just One API (RapidAPI), эндпоинты `/api/taobao/search`, `/api/taobao/item/:id`, `/api/taobao/description/:id`, и обёртки для перевода описаний.  
5. Реализовать внутреннюю корзину и склад: эндпоинты для добавления/удаления товаров, перехода между статусами; отображение в UI.  
6. Подключить бесплатные сервисы перевода и AI‑модели для генерации текстов (разделить нагрузку между Яндекс, Microsoft, DeepSeek).  
7. Реализовать раздел Статистика и Тренды на основе данных из D1 и ответов API.  
8. Доработать интеграцию с FanPay (ручную или полуавтоматическую), публикацию и обновление цен.  
9. Внедрить аутентификацию (логин/пароль, JWT, роли).  
10. Наладить отправку уведомлений в Telegram (через Bot API) и вывод их в UI.  

Этот документ служит основанием для последующей разработки. Следующий документ (`architecture.md`) описывает высокоуровневую архитектуру и организацию кода.

## 7. Решения для первого релиза (интеграции)

### 7.1 Just One API — методы, которые используем в MVP

* **Поиск**: `searchProducts(query, filters)` — основной метод для получения списка товаров по ключевым словам и фильтрам (тип ресурса, диапазон цен, сортировка). Фильтрация по игре и параметрам передаётся в объекте `filters`.
* **Детали товара**: `getProductDetail(itemId)` — название, цена, изображения, продавец, доставка. Используется сразу после выбора карточки из поиска.
* **Описание товара**: `getProductDescription(itemId)` — HTML → plain text для последующего перевода и генерации карточки.
* **Отзывы**: `getProductComments(itemId)` — подборка отзывов/оценок для витрины и раздела «Отзывы».

На первом релизе **не** используем методы, связанные с продажами (`getProductSales`), чтобы сократить бюджет RapidAPI; их добавим позже в разделе «Тренды» при необходимости.

### 7.2 Переводчики: дефолт и fallback с лимитами

* **Дефолт** — **Yandex.Translate**: бесплатная квота ≈ **1 млн символов в день**. Вызывается первой до исчерпания суточного лимита.
* **Fallback #1** — **Microsoft Translator Text**: бесплатная квота ≈ **2 млн символов в месяц**. Активируется при ошибке/таймауте Yandex или достижении дневного лимита.
* **Fallback #2** — **Cloudflare Workers AI (m2m100)**: бесплатная квота ≈ **10 000 нейронов в сутки** (хватает на ~1 000 коротких текстов). Вызывается, если оба предыдущих недоступны. Ограничиваем длину текста и устанавливаем троттлинг по количеству вызовов.

Логика в `lib/translate.ts`: циклическая проверка доступности (health‑check) и подсчёт израсходованных лимитов; при каждом запросе выбирается первый доступный провайдер по порядку Yandex → Microsoft → Workers AI.

### 7.3 Публикация на FunPay: процесс и API-контракты

Переходим к гибридной схеме: **полуручные запросы с подготовкой данных**, чтобы избежать блокировок и капч.

* **Шаг 1: подготовка драфта (ручной постинг)**
  * `POST /api/funpay/draft` — вход: `productId`, `price`, `currency`, `descriptionRu`, `descriptionEn`, `game`, `category`, `images[]`.
  * Ответ: готовый JSON/форм‑data payload, подсказки по заполнению форм, статус проверки (например, «нужен вход в аккаунт FunPay», «ожидается капча»).
  * Оператор вручную вставляет данные в форму FunPay и подтверждает публикацию.

* **Шаг 2: полуавтоматическая отправка (опционально)**
  * `POST /api/funpay/submit` — вход: `productId`, `sessionCookies`, `csrfToken`, `payload` (то, что вернул драфт), флаг `dryRun`.
  * Вызывает HTTP‑запрос к FunPay от имени авторизованной сессии. В случае капчи или 403 возвращает `requiresManual=true` и ссылку на товар/форму.

* **Статусы и аудит**
  * Таблица `products` дополняется полями `funpay_status` (`draft`, `manual_pending`, `published`, `error`) и `funpay_listing_url`.
  * В разделе «Уведомления» фиксируем события публикации и ошибки (ошибка логина, капча, таймаут).

Таким образом, для первого релиза обеспечиваем гарантированный ручной сценарий и безопасный полуавтоматический путь без риска блокировки аккаунта.
