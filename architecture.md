# Game Trade Hub — Архитектура

Этот документ описывает высокоуровневую архитектуру проекта Game Trade Hub. Он служит ориентиром для дальнейшей разработки: какие модули необходимы, как организованы данные, какие интеграции используются и как взаимодействуют компоненты.

## 1. Общий обзор

Проект состоит из двух основных частей:

1. **Фронт‑end** (административная панель) – основан на **Cloudflare Pages**. UI реализуется на Tailwind CSS (на базе шаблона Salient) и представляет собой SPA/PWA со страницами для всех разделов. Фронт обращается к backend через REST API для загрузки данных и выполнения действий (создание фильтров, добавление товаров, публикация).  
2. **Back‑end** – построен на **Cloudflare Workers** и выполняет роль API‑сервера. Он предоставляет эндпоинты для работы с товарами, корзиной, складом, статистикой, трендами, пользователями, а также проксирует запросы к внешним сервисам (RapidAPI, сервисы перевода, биржи). Бекенд использует **Cloudflare D1** для хранения данных и, по мере необходимости, **Workers KV**, **R2**, **Workers AI**.  

Cloudflare автоматически проксирует статический контент через CDN, обеспечивает SSL и защищает приложение от DDoS. Данные и файлы хранятся в распределённых серверах Cloudflare, что минимизирует задержки и необходимость поддержки инфраструктуры.

## 2. Структура репозитория

Проект рекомендуется организовать следующим образом:

```
game-trade-hub/
│
├─ admin/             # фронт-end (Cloudflare Pages)
│   ├─ index.html     # основной файл страницы
│   ├─ assets/        # изображения, SVG, иконки
│   └─ ...            # дополнительные страницы (при необходимости)
│
├─ worker/            # back-end (Cloudflare Worker)
│   ├─ wrangler.toml  # конфигурация Worker'а и привязок
│   ├─ index.ts/tsx   # корневой файл Worker'а (маршрутизация)
│   └─ src/
│       ├─ infra/         # низкоуровневые клиенты и утилиты
│       │   └─ justoneapi/
│       │       ├─ client.ts         # обёртка над API Taobao/Tmall
│       │       └─ types.ts          # интерфейсы ответов API
│       ├─ domains/       # бизнес-логика по предметным областям
│       │   ├─ games/
│       │   │   ├─ models.ts        # модели игр, фильтров
│       │   │   ├─ service.ts       # сервисы для работы с играми и фильтрами
│       │   │   └─ routes.ts        # REST эндпоинты для управления фильтрами игр
│       │   ├─ products/
│       │   │   ├─ models.ts        # модели товаров, корзины, склада
│       │   │   ├─ service.ts       # логика работы с товарами (создание, обновление, статусы)
│       │   │   └─ routes.ts        # эндпоинты API (CRUD для товаров)
│       │   ├─ stats/
│       │   │   ├─ service.ts       # расчёт статистики (расход, доход, ROI)
│       │   │   └─ routes.ts        # эндпоинты для статистики
│       │   ├─ trends/
│       │   │   ├─ service.ts       # анализ трендов (API Sales, Comments, search trends)
│       │   │   └─ routes.ts        # эндпоинты для получения трендов
│       │   ├─ users/
│       │   │   ├─ models.ts        # модели пользователей, ролей
│       │   │   ├─ service.ts       # логика аутентификации, авторизации
│       │   │   └─ routes.ts        # эндпоинты: login, register, change password
│       │   ├─ notifications/
│       │   │   ├─ service.ts       # логика создания и отправки уведомлений (Telegram + UI)
│       │   │   └─ routes.ts        # API для получения уведомлений
│       │   └─ settings/
│       │       ├─ models.ts        # настройки интеграций (tokens, наценка, курсы)
│       │       ├─ service.ts       # логика чтения/записи настроек
│       │       └─ routes.ts        # эндпоинты для обновления настроек
│       └─ lib/
│           ├─ d1.ts            # вспомогательные функции для D1 (execute, prepare)
│           ├─ jwt.ts           # работа с JWT (подпись, проверка)
│           ├─ response.ts      # генерация стандартных HTTP ответов
│           ├─ translate.ts     # абстракция над разными API переводов (Yandex, MS, AI)
│           └─ workers_ai.ts    # обёртка над Cloudflare Workers AI
│
├─ docs/              # документы (requirements.md, architecture.md, …)
└─ README.md
```

Деление кода на `infra`, `domains`, `lib` и `routes` помогает соблюдать чистую архитектуру: внешние зависимости (API), бизнес‑логика, вспомогательные функции, и HTTP‑маршрутизация разделяются. Это упрощает тестирование и поддержку.

## 3. Data flow (поток данных)

1. **Фронт‑end** отправляет запрос на бекенд по HTTPS (через Worker).  
2. **Router** (в Worker) определяет, какой сервис обработает запрос, и проверяет авторизацию (роль пользователя).  
3. **Service** выполняет бизнес‑логику: обращается к базе D1 (через вспомогательные функции), вызывает внешний API (например Just One API) или модуль переводов (через `translate.ts`), создаёт/обновляет записи.  
4. **Логика уведомлений** создаёт сообщения и отправляет их в Telegram (через Bot API), а также сохраняет в таблицу уведомлений.  
5. **Response** формирует стандартный JSON‑ответ (status, data, error) для фронта.  
6. **Cloudflare Pages** (фронт) получает JSON и обновляет UI.  

## 4. Схема данных (D1)

Предлагаемая схема таблиц (основные поля):

### 4.1 Игры и фильтры

* `games (id, name, description)` – список игр.  
* `filter_sets (id, game_id, name, price_min, price_max, params_json, markup_percent)` – наборы фильтров для поиска товаров, привязанные к игре; `params_json` хранит уникальные параметры для игры (уровни, VIP, количество ресурсов).  

### 4.2 Товары, корзина, склад

* `products (id, external_id, game_id, type, title, price_cny, price_usd, description_ru, description_en, images_json, status, source, created_at, updated_at)` – основная таблица товаров. `status` может быть: `cart` (в корзине), `warehouse` (на складе), `showcase` (опубликован), `sold` (продан). `source` — идентификатор API/площадки (например, `taobao`).  
* `orders (id, product_id, purchase_price_cny, purchase_price_usd, sale_price_usd, sale_platform, commission, profit, created_at, sold_at)` – записи о продажах.  
* `cart_items (id, product_id, quantity, added_at)` – содержимое внутренней корзины (можно объединить с `products` через `status`).  

### 4.3 Пользователи и роли

* `users (id, username, password_hash, role, created_at, is_active)` – таблица пользователей.  
* `sessions (id, user_id, jwt_token, expires_at)` – активные сессии, если нужна механика выхода.  

### 4.4 Настройки, уведомления и прочие

* `settings (id, key, value)` – ключевые настройки (RapidAPI token, курсы валют, наценки, лимиты парсинга).  
* `notifications (id, type, message, level, created_at, read)` – системные уведомления (уровни: info, warning, error).  
* `logs (id, source, message, details_json, created_at)` – необязательно, для технических логов (парсинг, интеграции).  

В будущем, если понадобится держать большие данные (например, историю трендов за долгое время), можно подключить внешнюю систему (Cloudflare Analytics Engine или сторонние базы), но для наших нужд D1 достаточно.

## 5. Работа с внешними API

### 5.1 Just One API (Taobao/Tmall)

Обёртка `infra/justoneapi/client.ts` реализует методы:

* `searchProducts(query: string, filters: object): Promise<SearchResult[]>` – выполняет поиск по ключевым словам и фильтрам (тип ресурса, price_min/price_max, сортировка).  
* `getProductDetail(itemId: string): Promise<ProductDetail>` – получает название, цену, изображения, продавца.  
* `getProductDescription(itemId: string): Promise<string>` – вытягивает HTML и преобразует в чистый текст для перевода.  
* `getProductSales(itemId: string, timeframe: string): Promise<SalesStats>` – возвращает статистику продаж (день, месяц).  
* `getProductComments(itemId: string): Promise<Comment[]>` – отзывы и оценки.  

Каждый метод добавляет заголовок `X-RapidAPI-Key` (берётся из переменных окружения) и проверяет поле `code` в ответе API. При возникновении ошибки (timeout, code != 0) метод логирует и возвращает ошибку сервису.

### 5.2 Сервисы перевода

Модуль `lib/translate.ts` инкапсулирует работу с несколькими API переводов. Он определяет подпровайдер (например, Yandex, Microsoft, DeepSeek) на основе доступной квоты и распределяет нагрузку. Общий интерфейс:

```ts
export async function translate(text: string, from: string, to: string): Promise<string>;
```

Внутри применяются разные драйверы:

* `translateYandex()` – вызывает Yandex.Translate API (до 1 млн символов/день).  
* `translateMicrosoft()` – вызывает Microsoft Translator Text API (до 2 млн символов/месяц).  
* `translateAI()` – использует Cloudflare Workers AI с моделью m2m100 для перевода (если есть свободные нейроны).  

Если один сервис недоступен или превысил лимит, модуль автоматически переключается на другой. Это позволяет сохранять бесплатность.

### 5.3 Cloudflare Workers AI

Модуль `lib/workers_ai.ts` оборачивает вызовы моделей AI. В зависимости от задачи выбирается модель из каталога:

* **Перевод** – модель `@cf/meta/m2m100-1.2b` (или другая из каталога), которая принимает входной текст и возвращает перевод.  
* **Генерация описаний** – модель Llama 2 или аналогичная; модуль принимает входные данные (переведённые параметры товара) и возвращает короткое продающее описание на русском/английском.  
* **Классификация изображений** (опционально) – модель ResNet для определения типа продукта по картинке.  

API Workers AI требует указания `binding` в `wrangler.toml`:

```toml
[[ai]]
binding = "AI"
model = "@cf/meta/m2m100-1.2b"
```

Вызов модели идёт через `fetch("/v1/models/...", {body: JSON.stringify({prompt: ...})})`. Рабочий код обёртки скрывает детали.

## 6. Авторизация и безопасность

* **JWT‑аутентификация**: при входе пользователь получает токен, подписанный секретом (секрет хранится в переменных Workers). Токен хранится в cookie `HttpOnly` или в localStorage на фронте. Проверка токена и ролей выполняется в middleware Worker'а.  
* **Пароли**: хранятся как хэши (рекомендуется Argon2 или bcrypt). Регистрация пользователей выполняет проверку на сложность пароля.  
* **CORS**: разрешены запросы только с домена Cloudflare Pages сайта.  
* **Хранение ключей**: токены RapidAPI, API‑ключи переводчиков, ключи Telegram‑бота и другие секреты сохраняются в разделе `vars` или `secrets` в `wrangler.toml`/Cloudflare Dashboard, не в коде.  
* **Rate limiting**: Cloudflare автоматически ограничивает слишком частые запросы; дополнительно можно в Worker установить ограничение на число API‑запросов от одного IP за минуту.  
* **Валидация ввода**: все входные данные (например, параметры фильтра, ID товара, текст описания) проверяются и валидируются перед использованием (SQL‑инъекции и XSS отслеживаются).  

## 7. Реализация API и маршрутов

В файле `worker/index.ts` задаётся корневой обработчик `fetch(request)`, который маршрутизирует запросы:

1. **/api/taobao/search** (GET) – поиск товаров. Принимает query, фильтры, сортировку; вызывает `justoneapi.client.searchProducts` и возвращает нормализованные результаты.  
2. **/api/taobao/item/:id** (GET) – детали товара. Вызывает `getProductDetail` и записывает данные в БД, если товар ещё не сохранён.  
3. **/api/taobao/description/:id** (GET) – получает HTML‑описание, очищает, переводит (через `translate.ts`), сохраняет в D1.  
4. **/api/products** (POST, GET, PUT, DELETE) – CRUD для товаров в корзине/складе/витрине.  
5. **/api/orders** (POST, GET) – фиксация продажи; расчёт маржи, комиссия; добавление в таблицу `orders`.  
6. **/api/stats** (GET) – статистика расход/доход/ROI, берёт данные из `orders` и `products`.  
7. **/api/trends** (GET) – тренды; агрегирует данные из Sales API и `comments` для топ‑категорий.  
8. **/api/users/login**, **/api/users/register**, **/api/users/me** – аутентификация, регистрация и данные текущего пользователя.  
9. **/api/settings** – чтение/запись настроек интеграций.  
10. **/api/notifications** – список уведомлений; можно добавить endpoint для отметки как прочитанное.  

Каждый эндпоинт проверяет роль пользователя и форматирует ответ. Ошибки (внешнего API, БД) оборачиваются в стандартный JSON: `{error: string, details: any}`.  

## 8. Дополнительные возможности

* **Крон‑триггеры** – можно настроить (через Cloudflare Workers Cron) задачи, которые раз в N часов обновляют статистику продаж по выбранным товарам, или пересчитывают тренды.  
* **Queues** – Cloudflare Queues позволяют выстраивать асинхронные задачи (например, запросы на перевод или парсинг большого количества товаров) и обрабатывать их в фоне. Бесплатный тариф даёт 100 000 сообщений/месяц, чего достаточно для 1000 товаров.  
* **Vectorize** – сервис векторных баз данных. Его можно применить для семантического поиска по описаниям товаров (функция «похожие товары») или рекомендаций. При 1000 товаров бесплатный лимит (5 млн операций сравнения в месяц) более чем достаточен.  
* **AI Gateway** – можно использовать для проксирования запросов к внешним AI‑провайдерам (OpenAI, Anthropic). Он позволяет кэшировать одинаковые запросы, контролировать расходы и делить ключи. Пока это не требуется, но предусмотрено в архитектуре.

## 9. План работ по разработке

1. **Создание репозитория и базовой структуры** (admin/, worker/, docs/).  
2. **Разработка фронт‑энда**: сверстать главные разделы панели по макету; подключить Tailwind CSS; настроить навигацию.  
3. **Настройка wrangler.toml**: указать привязки D1, KV, AI (если используется), secrets для RapidAPI и других ключей.  
4. **Разработка обёртки Just One API** (client.ts).  
5. **Реализация маршрутов API** по пунктам 7.  
6. **Создание схемы БД** и миграций: таблицы игр, фильтров, товаров, orders, users, settings, notifications.  
7. **Подключение переводчиков** (Yandex/MS) и Workers AI (перевод, генерация описаний); реализация модуля `translate.ts`.  
8. **Настройка аутентификации**: генерация JWT, хранение паролей, middleware для проверки прав.  
9. **Визуализация статистики и трендов**: построение графиков (Chart.js или любой другой), таблиц и отчётов на фронте.  
10. **Интеграция с биржами** (начать с FunPay): ручная/полуавтоматическая публикация; вывод ссылки на объявление в карточке товара.  
11. **Тестирование**: автоматические и ручные тесты для ключевых функций (поиск, добавление в корзину, фиксация продаж).  
12. **Документация**: обновлять `README.md`, описывать эндпоинты API и UI.  

Этот документ следует использовать как техническое руководство для разработчиков. В случае изменений в архитектуре или добавления новых сервисов его необходимо обновлять.