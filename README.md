# CRM-Gamix

Минимальный скелет для админки и API. Чтобы локально прогнать связку и проверить базовые ручки `/api/health` и `/api/products`,
используйте следующие шаги:

1. Установите зависимости для Worker и запустите dev-сервер Cloudflare:
   ```bash
   cd worker
   npm install
   npm run dev -- --local
   ```
   По умолчанию Wrangler слушает порт `8787`.

2. Поднимите статику админки из каталога `admin` любым удобным способом, например встроенным HTTP-сервером Python:
   ```bash
   cd ..
   python3 -m http.server 4173 --directory admin
   ```
   Откройте в браузере http://127.0.0.1:4173. В блоке «API база» укажите `http://127.0.0.1:8787` и нажмите «Сохранить».

3. Нажмите «Проверить /api/health» и «Обновить» в секции «Склад». Если схема D1 применена, можно добавить товар через форму; ре
зультат появится в таблице справа.

Схема базы лежит в `worker/db/schema.sql`. Привязку D1 укажите в `worker/wrangler.toml`.

## Вход и регистрация в админку

Админка работает с пользователями из таблицы `users` в D1. Доступные ручки:

- `POST /api/register` — создаёт пользователя. Первая учётка автоматически получает роль `admin`, все следующие — `trader`.
- `POST /api/login` — вход по email/username и паролю, токен возвращается в `Authorization: Bearer ...`.
- `POST /api/telegram/login` — упрощённая авторизация через payload Telegram Login Widget; первый Telegram-пользователь тоже становится админом.

Токен хранится в LocalStorage и подставляется во все запросы админки. Для подписи нужен секрет:

- `ADMIN_SECRET` — обязательный секрет для HMAC. Если не задать, воркер попытается использовать `ADMIN_PASSWORD`, но рекомендовано явно указать секрет.
- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота для проверки подписи Login Widget. Сообщите username бота и домен, с которого будет открыт виджет, чтобы я мог встроить ссылку/кнопку.

Доступ к статике админки защищён HTTP Basic Auth. По умолчанию нужен только пароль `gth-protect-9824`; при деплое можно переопределить его переменной `ADMIN_GATE_PASS`. Логин можно оставить пустым или любым значением.

Пароли и токены не завязаны на переменные окружения `ADMIN_EMAIL/ADMIN_PASSWORD`: база D1 уже подключена, учётки создаются прямо через API или Telegram.

## Проверка готовой связки

Если Worker уже крутится в облаке, достаточно раздать статику из каталога `admin` (например, через любой CDN или Pages) и в блоке «API база» указать публичный URL воркера. Нажмите «Проверить /api/health» — при статусе `OK` можно добавлять товары через форму и смотреть таблицу справа.

Для быстрой проверки можно передать базу API в URL админки параметром `?apiBase=https://your-worker.example.workers.dev`. Интерфейс автоматически выполнит `/api/health`, покажет бейдж подключения и разблокирует остальные кнопки только при успешном ответе.

Админка поддерживает обновление статуса с комментарием, просмотр истории, удаление товара и получение сводки/трендов по API. Регистрация вынесена на отдельные страницы `/register.html` (email/пароль) и `/register-telegram.html` (Telegram Login). После успешной регистрации пользователь сразу перенаправляется в основную админку.

## Что требуется настроить перед проверкой

1. Прописать в `wrangler.toml` или через `wrangler secret put` переменные `ADMIN_SECRET` (для подписи токенов) и `TELEGRAM_BOT_TOKEN` (если нужен Telegram вход).
2. Применить миграции D1 (`worker/db/schema.sql`) и убедиться, что биндинг `DB` смотрит на правильную базу (таблица `users` нужна для входа/регистрации).
3. Деплойнуть воркер: `cd worker && npm install && npm run deploy`. Статика из каталога `admin` будет отдаваться тем же доменом воркера благодаря секции `[assets]`.
4. Открыть https://gmhub.gromakoff.workers.dev/ — доступ защищён базовой авторизацией только по паролю (по умолчанию `gth-protect-9824`; логин можно оставить пустым или любым). Там есть ссылки на регистрацию по email и через Telegram. При необходимости переопределите базу через `?apiBase=`.
