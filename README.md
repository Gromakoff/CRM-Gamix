# CRM-Gamix

Минимальный скелет для админки и API. Чтобы локально прогнать связку и проверить базовые ручки `/api/health` и `/api/products`,
используйте следующие шаги:

1. Установите зависимости для Worker и запустите dev-сервер Cloudflare:
   ```bash
   cd worker
   npm install
   npm run dev -- --local
   ```
   По умолчанию Wrangler слушает порт `8787`.

2. Поднимите статику админки из каталога `admin` любым удобным способом, например встроенным HTTP-сервером Python:
   ```bash
   cd ..
   python3 -m http.server 4173 --directory admin
   ```
   Откройте в браузере http://127.0.0.1:4173. В блоке «API база» укажите `http://127.0.0.1:8787` и нажмите «Сохранить».

3. Нажмите «Проверить /api/health» и «Обновить» в секции «Склад». Если схема D1 применена, можно добавить товар через форму; ре
зультат появится в таблице справа.

Схема базы лежит в `worker/db/schema.sql`. Привязку D1 укажите в `worker/wrangler.toml`.

## Вход в админку

Перед панелями теперь реальная авторизация: форма логина вызывает `/api/login`, воркер сверяет учетные данные и выдает подписанный токен (Authorization: Bearer ...). Токен хранится в LocalStorage и автоматически подставляется во все запросы админки.

Перед деплоем задайте переменные окружения:

- `ADMIN_EMAIL` — логин администратора.
- `ADMIN_PASSWORD` — пароль администратора.
- `ADMIN_SECRET` — (рекомендовано) отдельный секрет для подписи токенов. Если не задан, используется пароль.

Без этих переменных `/api/login` вернет ошибку, а админка будет показывать приглашение к настройке.

## Проверка готовой связки

Если Worker уже крутится в облаке, достаточно раздать статику из каталога `admin` (например, через любой CDN или Pages) и в блоке «API база» указать публичный URL воркера. Нажмите «Проверить /api/health» — при статусе `OK` можно добавлять товары через форму и смотреть таблицу справа.

Для быстрой проверки можно передать базу API в URL админки параметром `?apiBase=https://your-worker.example.workers.dev`. Интерфейс автоматически выполнит `/api/health`, покажет бейдж подключения и разблокирует остальные кнопки только при успешном ответе.

Админка поддерживает обновление статуса с комментарием, просмотр истории, удаление товара и получение сводки/трендов по API.

## Что требуется настроить перед проверкой

1. Прописать в `wrangler.toml` или через `wrangler secret put` переменные `ADMIN_EMAIL`, `ADMIN_PASSWORD` и (желательно) `ADMIN_SECRET` для выдачи токенов.
2. Применить миграции D1 (`worker/db/schema.sql`) и убедиться, что биндинг `DB` смотрит на правильную базу.
3. Деплойнуть воркер: `cd worker && npm install && npm run deploy`. Статика из каталога `admin` будет отдаваться тем же доменом воркера благодаря секции `[assets]`.
4. Открыть https://game-trade-hub-worker.gromakoff.workers.dev/ — там сразу будет форма логина и весь интерфейс админки с подключением к API на том же домене. При необходимости можно переопределить базу через `?apiBase=`.
